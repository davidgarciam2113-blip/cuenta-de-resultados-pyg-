<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PyG — I/II/III/IV (múltiplos 1.000, financiero, sin variación, imp 25%)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #f6f7fb; color: #111; }
    .wrap { max-width: 1050px; margin: 0 auto; padding: 16px; }
    .card { background: white; border-radius: 14px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.06); margin: 12px 0; }
    h1 { font-size: 20px; margin: 0 0 6px; }
    h2 { font-size: 16px; margin: 0 0 10px; }
    .muted { color: #555; font-size: 13px; }
    label { font-weight: 900; font-size: 13px; display:block; margin-bottom: 6px; }

    input, select, button {
      font-size: 16px; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #d8dbe6; width: 100%; box-sizing: border-box;
    }
    button { border: 0; background: #2563eb; color: white; font-weight: 900; cursor: pointer; }
    button.secondary { background: #111827; }
    button:disabled { opacity: .6; cursor: not-allowed; }

    .row { display:grid; gap: 10px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .row { grid-template-columns: 1.2fr 1fr 1fr; } }

    .grid { display:grid; gap: 12px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }

    .box { border: 1px solid #eef0f7; border-radius: 12px; padding: 12px; background: #fafbff; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#eef2ff; color:#1e40af; font-weight:900; font-size: 12px; margin-right: 8px; }

    table { width:100%; border-collapse: collapse; }
    td { padding: 8px 6px; border-bottom: 1px solid #e9ecf5; vertical-align: top; }
    td.right { text-align:right; white-space: nowrap; font-variant-numeric: tabular-nums; }
    .hint { font-size: 12px; color: #555; }

    .result { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background: #0b1220; color: #e5e7eb; padding: 12px; border-radius: 12px; overflow:auto;
    }

    .square { border: 2px solid #111827; border-radius: 10px; padding: 10px 12px; background: #fff; }
    .ok { border-color: #16a34a !important; }
    .bad { border-color: #dc2626 !important; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>Cuenta de Pérdidas y Ganancias — epígrafes exactos</h1>
    <div class="muted">
      <b>Múltiplos de 1.000</b>. Sin variación de existencias. <b>Con operaciones financieras</b>. Impuesto fijo: <b>25%</b>.
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>Nombre y apellidos</label>
        <input id="alumno" placeholder="Ej: Laura García López" autocomplete="name">
      </div>

      <div>
        <label>Nivel</label>
        <select id="nivel">
          <option value="basico" selected>Básico</option>
          <option value="medio">Medio</option>
          <option value="completo">Completo (más variedad de gastos)</option>
        </select>
      </div>

      <div style="display:grid; gap:10px;">
        <button id="btnGenerar">Generar caso</button>
        <button id="btnCorregir" class="secondary" disabled>Corregir</button>
      </div>
    </div>
    <div class="muted" style="margin-top:8px;">
      Escribe números enteros. Todo está en miles. Corrección con tolerancia ±1.
    </div>
  </div>

  <div class="grid">
    <div class="card" id="zonaDatos" style="display:none;">
      <h2>Datos del caso</h2>
      <div class="box">
        <table id="tablaDatos"></table>
      </div>
      <div class="muted" style="margin-top:10px;">
        Aquí <b>no hay variación de existencias</b>, por tanto <b>aprovisionamientos = compras</b>.
      </div>
    </div>

    <div class="card" id="zonaInputs" style="display:none;">
      <h2>Resultados solicitados (epígrafes exactos)</h2>
      <div class="box">
        <table>
          <tr>
            <td><b>I. Resultado de la explotación</b></td>
            <td style="width:170px;"><input class="square" id="in_I" inputmode="numeric" placeholder="0"></td>
            <td class="hint">Ingresos explotación − Gastos explotación</td>
          </tr>
          <tr>
            <td><b>II. Resultado financiero</b></td>
            <td><input class="square" id="in_II" inputmode="numeric" placeholder="0"></td>
            <td class="hint">Ingresos financieros − Gastos financieros</td>
          </tr>
          <tr>
            <td><b>III = I + II. Resultado antes de impuestos (BAI)</b></td>
            <td><input class="square" id="in_III" inputmode="numeric" placeholder="0"></td>
            <td class="hint">III = I + II</td>
          </tr>
          <tr>
            <td><b>Impuesto sobre beneficios (25%)</b></td>
            <td><input class="square" id="in_IMP" inputmode="numeric" placeholder="0"></td>
            <td class="hint">0,25 × III (si III &gt; 0; si no, 0)</td>
          </tr>
          <tr>
            <td><b>IV = Resultado del ejercicio = III − Impuesto sobre beneficios</b></td>
            <td><input class="square" id="in_IV" inputmode="numeric" placeholder="0"></td>
            <td class="hint">IV = III − Impuesto</td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div class="card" id="zonaResultado" style="display:none;">
    <h2>Corrección</h2>
    <div id="resumen"></div>
    <div style="height:10px;"></div>

    <div class="box">
      <h3 style="margin:0 0 8px;">Estructura correcta completa (ítems + cálculos)</h3>
      <div class="result" id="solucionTxt"></div>
    </div>
  </div>

</div>

<script>
const TOL = 1;
const STEP = 1000;
const IMP = 0.25;

let caso = null;
const $ = (id) => document.getElementById(id);

function rndStep(min, max, step=STEP){
  const a = Math.ceil(min / step);
  const b = Math.floor(max / step);
  return (Math.floor(Math.random() * (b - a + 1)) + a) * step;
}
function money(n){ return String(Math.round(n)); }
function parseNum(v){
  const x = (v || "").toString().replace(",", ".").trim();
  const n = Number(x);
  return Number.isFinite(n) ? n : NaN;
}
function closeEnough(a, b){ return Math.abs(a - b) <= TOL; }
function fmtGasto(n){ return `(${money(Math.abs(n))})`; }

// Ajusta el resultado financiero para que BAI sea múltiplo de 4.000 (y así el 25% sea múltiplo de 1.000)
function ajustarFinancieroParaBAI(resExplot, resFin){
  const bai = resExplot + resFin;
  const mod = ((bai % 4000) + 4000) % 4000;
  if (mod === 0) return resFin;
  // restar 'mod' mantendrá múltiplo de 4.000 (sin romper múltiplos de 1.000 porque mod es múltiplo de 1.000)
  return resFin - mod;
}

function generarCaso(){
  const nivel = $("nivel").value;

  // Ventas (INCN) sin devoluciones/descuentos
  const ventas = rndStep(200000, 650000);
  const incn = ventas;

  // Aprovisionamientos = Compras
  const compras = rndStep(80000, 280000);
  const aprovisionamientos = compras;

  // Personal
  const sueldos = rndStep(20000, 160000);
  const ssEmpresa = rndStep(10000, 70000);
  const personal = sueldos + ssEmpresa;

  // Otros gastos explotación
  const suministros = rndStep(2000, 22000);
  const alquileres = rndStep(3000, 32000);
  const publicidad = rndStep(0, (nivel === "basico") ? 10000 : 25000);
  const reparaciones = rndStep(0, 18000);
  const transportes = (nivel === "completo") ? rndStep(0, 15000) : 0;
  const otrosGastos = suministros + alquileres + publicidad + reparaciones + transportes;

  // Amortización
  const amort = rndStep(5000, 50000);

  // I
  const resExplot = incn - aprovisionamientos - personal - otrosGastos - amort;

  // Operaciones financieras (múltiplos de 1.000)
  let ingFin = rndStep(0, 25000);
  let gasFin = rndStep(0, 30000);
  let resFin = ingFin - gasFin;

  // Ajuste para que III (BAI) sea múltiplo de 4.000 (y el impuesto 25% sea múltiplo de 1.000)
  resFin = ajustarFinancieroParaBAI(resExplot, resFin);

  // Mantener consistencia: recalculamos gasFin para respetar ingFin - gasFin = resFin
  // gasFin = ingFin - resFin, y debe quedar múltiplo de 1.000 (lo estará)
  gasFin = ingFin - resFin;

  // III
  const bai = resExplot + resFin;

  // Impuesto 25%
  const impuesto = bai > 0 ? bai * IMP : 0;

  // IV
  const resEj = bai - impuesto;

  caso = {
    nivel,
    ventas, incn,
    compras, aprovisionamientos,
    sueldos, ssEmpresa, personal,
    suministros, alquileres, publicidad, reparaciones, transportes, otrosGastos,
    amort,
    ingFin, gasFin, resFin,
    resExplot, bai, impuesto, resEj,
    tipoImp: IMP
  };

  renderDatos();
  resetInputs();
  $("zonaDatos").style.display = "";
  $("zonaInputs").style.display = "";
  $("zonaResultado").style.display = "none";
  $("btnCorregir").disabled = false;
}

function renderDatos(){
  const rows = [];
  rows.push(["Ventas (INCN)", money(caso.ventas)]);
  rows.push(["Compras (Aprovisionamientos)", money(caso.compras)]);

  rows.push(["Sueldos y salarios", money(caso.sueldos)]);
  rows.push(["Seguridad Social (empresa)", money(caso.ssEmpresa)]);
  rows.push(["Gastos de personal (total)", money(caso.personal)]);

  rows.push(["Suministros", money(caso.suministros)]);
  rows.push(["Alquileres", money(caso.alquileres)]);
  rows.push(["Publicidad", money(caso.publicidad)]);
  rows.push(["Reparaciones y conservación", money(caso.reparaciones)]);
  rows.push(["Transportes", money(caso.transportes)]);
  rows.push(["Otros gastos de explotación (total)", money(caso.otrosGastos)]);

  rows.push(["Amortización", money(caso.amort)]);

  rows.push(["Ingresos financieros", money(caso.ingFin)]);
  rows.push(["Gastos financieros", money(caso.gasFin)]);
  rows.push(["Tipo de impuesto", "25%"]);

  $("tablaDatos").innerHTML = rows.map(([k,v]) => `
    <tr><td>${k}</td><td class="right"><b>${v}</b></td></tr>
  `).join("");
}

function resetInputs(){
  ["in_I","in_II","in_III","in_IMP","in_IV"].forEach(id => {
    const el = $(id);
    el.value = "";
    el.classList.remove("ok","bad");
  });
}

function corregir(){
  const alumno = $("alumno").value.trim();
  if (alumno.length < 3){ alert("Escribe nombre y apellidos."); return; }
  if (!caso){ alert("Primero genera un caso."); return; }

  const expected = {
    in_I: caso.resExplot,
    in_II: caso.resFin,
    in_III: caso.bai,
    in_IMP: caso.impuesto,
    in_IV: caso.resEj
  };

  const keys = Object.keys(expected);
  let ok = 0;

  keys.forEach(k => {
    const input = $(k);
    const val = parseNum(input.value);
    const exp = expected[k];

    if (!Number.isFinite(val)){
      input.classList.add("bad"); input.classList.remove("ok");
      return;
    }
    if (closeEnough(val, exp)){
      ok++;
      input.classList.add("ok"); input.classList.remove("bad");
    } else {
      input.classList.add("bad"); input.classList.remove("ok");
    }
  });

  const total = keys.length;
  const fallos = total - ok;
  const pctOk = (ok / total) * 100;
  const pctFail = (fallos / total) * 100;
  const nota = Math.round((ok / total) * 10 * 100) / 100;

  $("zonaResultado").style.display = "";
  $("resumen").innerHTML = `
    <div class="pill">Alumno: ${alumno}</div>
    <div style="height:8px"></div>
    <div class="pill">Aciertos: ${ok}/${total} (${pctOk.toFixed(1)}%)</div>
    <div class="pill">Errores: ${fallos}/${total} (${pctFail.toFixed(1)}%)</div>
    <div class="pill">Nota: ${nota.toFixed(2)} / 10</div>
  `;

  $("solucionTxt").textContent = buildSolucionCompleta();
  $("zonaResultado").scrollIntoView({behavior:"smooth", block:"start"});
}

function buildSolucionCompleta(){
  const L = [];
  L.push("LA ESTRUCTURA DE LA CUENTA DE PÉRDIDAS Y GANANCIAS (CORRECTA)");
  L.push("=============================================================");
  L.push("");
  L.push("I. RESULTADO DE LA EXPLOTACIÓN");
  L.push("");
  L.push("   INGRESOS DE EXPLOTACIÓN");
  L.push(`     Ventas (INCN):                        ${money(caso.ventas)}`);
  L.push("");
  L.push("   GASTOS DE EXPLOTACIÓN");
  L.push(`     Aprovisionamientos (Compras):         ${fmtGasto(caso.compras)}`);
  L.push("");
  L.push("     Gastos de personal");
  L.push(`       Sueldos y salarios:                 ${fmtGasto(caso.sueldos)}`);
  L.push(`       Seguridad Social (empresa):         ${fmtGasto(caso.ssEmpresa)}`);
  L.push(`       Total personal:                     ${fmtGasto(caso.personal)}`);
  L.push("");
  L.push("     Otros gastos de explotación");
  L.push(`       Suministros:                        ${fmtGasto(caso.suministros)}`);
  L.push(`       Alquileres:                         ${fmtGasto(caso.alquileres)}`);
  L.push(`       Publicidad:                         ${fmtGasto(caso.publicidad)}`);
  L.push(`       Reparaciones y conservación:         ${fmtGasto(caso.reparaciones)}`);
  L.push(`       Transportes:                        ${fmtGasto(caso.transportes)}`);
  L.push(`       Total otros gastos:                 ${fmtGasto(caso.otrosGastos)}`);
  L.push("");
  L.push(`     Amortización:                         ${fmtGasto(caso.amort)}`);
  L.push("");
  L.push("   I = Ingresos de explotación − Gastos de explotación");
  L.push(`   I = ${money(caso.incn)} − ${money(caso.aprovisionamientos)} − ${money(caso.personal)} − ${money(caso.otrosGastos)} − ${money(caso.amort)}`);
  L.push(`   I = ${money(caso.resExplot)}`);
  L.push("");
  L.push("II. RESULTADO FINANCIERO");
  L.push(`   Ingresos financieros:                    ${money(caso.ingFin)}`);
  L.push(`   Gastos financieros:                      ${fmtGasto(caso.gasFin)}`);
  L.push(`   II = ${money(caso.ingFin)} − ${money(caso.gasFin)} = ${money(caso.resFin)}`);
  L.push("");
  L.push("III = I + II. RESULTADO ANTES DE IMPUESTOS (BAI)");
  L.push(`   III = ${money(caso.resExplot)} + ${money(caso.resFin)} = ${money(caso.bai)}`);
  L.push("");
  L.push("IMPUESTO SOBRE BENEFICIOS (25%)");
  L.push("   Si III > 0, impuesto = 0,25 × III; si III ≤ 0, impuesto = 0.");
  L.push(`   Impuesto = ${money(caso.impuesto)}`);
  L.push("");
  L.push("IV = RESULTADO DEL EJERCICIO = III − IMPUESTO SOBRE BENEFICIOS");
  L.push(`   IV = ${money(caso.bai)} − ${money(caso.impuesto)} = ${money(caso.resEj)}`);

  return L.join("\n");
}

$("btnGenerar").addEventListener("click", generarCaso);
$("btnCorregir").addEventListener("click", corregir);
</script>

</body>
</html>




